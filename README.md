# Zoom Plays

This is my attempt to emulate a "twitch plays"-like game but on the conference call platform Zoom.
This is my first time using using a web API so I'll be using this readme to document the dev process. I loosely followed the tutorial outlined [here](https://medium.com/swlh/how-i-automate-my-church-organisations-zoom-meeting-attendance-reporting-with-python-419dfe7da58c) by billydharmawan. Since I want to access the Zoom chat, I need to use Oauth 2.0 instead of JWT though.

**Roadmap with no detail whatsoever:**
1. Somehow extract commands from the messages in the chat log real time
1. Use commands to trigger key-events ~~emulated by x360ce xbox controller emulator~~
1. Open a game emulator ~~initialized to xbox controller~~ for gameplay

Strictly speaking, using the xbox controller is unnecessary. 
In fact, I ended up not using it.


Also, I attempted to use pipenv at first, but ran into some issues, so pipenv can be ignored for now.

## Text from In-Meeting Chat
Ok so in-meeting chat is different from regular chat and cannot easily be accessed. rip that idea.
(closest thing apparently is to use Zoom WebSDK and access chat features and message log through sessionStorage, but I have 0 experience with web dev)

## Text from Zoom Chat
Interfacing with the Zoom API relies heavily on the requests module. 
Basic Zoom Users have an API rate limit of 1 request per second, regardless of load. Need to upgrade for anything faster.

Much of the difficulty here lies in actually getting authorized and proper request formatting. The OAuth 2 authentication flow is extremely tedious, so when reading the [zoom oauth walkthrough](https://marketplace.zoom.us/docs/guides/auth/oauth) you need to pay careful attention to their flow. I will dedicate a subsection to just OAuth to explain it.

### The OAuth Authorization Flow
I said I'd do this but I'm tired now so I'll document this later. Or take a look at `zoom-plays-gba.py`, which is commented (sort of)

## Game Interface Notes 

To test the platform, I'll be testing with Pokemon Emerald, since it's something that has been done before and I can compare to.

**GBA Commands**
```
up, u 		# d-pad up
down, d 	# d-pad down
left, l 	# d-pad left
right, r 	# d-pad right
a 			# a button
b 			# b button
start 		# start button (not holdable)
select 		# select button (not holdable)
ltrig, lt 	# left trigger
rtrig, rt	# right trigger					
```
**GBA Command Formatting**
```
(!) (hold button) (+) (press button) (*) (multiplier)

(!) 			# indicates a button should be held
(hold button) 	# button to be held down
(+)				# indicates a button will be pressed while holding another button
(press button)	# button to press
(*)				# indicates a button will be pressed repeatedly, or held for some amount of time
(multiplier)	# number (< 500) of times button will be pressed
				# 	or length of time (< 5) in seconds held if no button is pressed

Note: by default, a button press lasts for 175ms. There's a 25ms gap between button presses
```
**Example**
```
a 			# press a
up*25		# press up 25 times
b+a 		# press a while holding b
!a 			# hold a (1 second by default)
!a*5 		# hold a for 5 seconds
b+up*25 	# press up 25 times while holding b
```

### Keystrokes

This is the stupid way to implement an interface--just have the script emulate user input. That means the user's keyboard gets hijacked and is useless while the game is running, so don't expect to get any work done while you're running this process.

I originally decided to use OpenEmu as a game emulator to test this, but alas, OpenEmu does not support AppleScript, which means that key events generated by conventional python libraries are useless since OpenEmu registers key events at a lower level (i.e. none of my generated keystrokes are registered by OpenEmu).

I have 3 options to try to get OpenEmu to rcognize my keystrokes:
1. I can attempt to build a virtual HID (Human Interface Device) that generates key events at a low enough level for OpenEmu to register it (see [cython-hidapi](https://pypi.org/project/hidapi/0.7.99.post14/))
1. I can try to pipe OSC commands to HID using [Osculator](http://www.osculator.net/) as suggested on the OpenEmu issue [thread](https://github.com/OpenEmu/OpenEmu/issues/1169)
1. I can try another emulator.

Let's go with #3 for now.

I've selected mGBA (which OpenEmu uses as it's GBA core) as an emulator and that seems to work, though there are some minor bugs in the emulator.

### LuaScripting

In seeing other examples of live plays, apparently Lua Scripting is a common way to hack a GBA emulator.
Ideally, I would like to write a Lua script to run in the emulator that grabs all it's commands from another process. This would be difficult to pull off, but probably worth it so I can use my keyboard again.
Unfortunately, most emulators compatible with macOS lack luascripting capabilities. There's only one known emulator that might have the capability, but it's outdated. See links for lua for more details. 

Currently waiting on mGBA to add support for this.


## Requirements

**This application was written for macOS**

Requirements below are also poorly documented. See `requirements.txt` for all dependencies and use a virtual environment to set up your machine.

**For Zoom API Calls**
- requests

**For OCR: (not necessary)**
- pillow
- tessaract==4.0
- pytesseract
- opencv-python
- textblob

**For Game Interface:**
- pyobjc-framework-quartz

### Useful Links

**For Zoom API**
- [pipenv](https://docs.python-guide.org/dev/virtualenvs/)
- [Zoom - OAuth with Zoom](https://marketplace.zoom.us/docs/guides/auth/oauth)
- [Zoom Git - OAuth Sample App](https://github.com/zoom/zoom-oauth-sample-app)
- [Zoom Forum - creating meeting oauth in python](https://devforum.zoom.us/t/creating-meeting-oauth-in-python-3-7/20821)
- [Zoom Forum - allow chatbots to join in-meeting chats](https://devforum.zoom.us/t/allow-chatbots-to-join-meeting-chats/8875/19)
- [Zoom - Creating Zoom SDK app](https://marketplace.zoom.us/docs/guides/build/sdk-app)
- [Zoom - WebSDK github](https://github.com/zoom/websdk)
- [Zoom - Marketplace](https://marketplace.zoom.us/)
- [Python Requests Documentation](https://www.w3schools.com/python/module_requests.asp)
- [Python Requests Tutorial](https://realpython.com/python-requests/)

**For How to OAuth**
- [stackoverflow - retrieve oauth code in redirect url](https://stackoverflow.com/questions/31308061/retrieve-oauth-code-in-redirect-url-provided-as-post-response)
- [OAuth2 Redirect URIs](https://www.oauth.com/oauth2-servers/redirect-uris/redirect-uri-registration/)
- [OAuth 2.0 Framework](https://tools.ietf.org/html/rfc6749)
- [OAuth Step by Step](http://www.lexev.org/en/2015/oauth-step-step/)
- [ZoomForum - understanding OAuth for Zoom](https://devforum.zoom.us/t/understanding-oauth-for-zoom/12444)
- [OAuth2 Simplified](https://aaronparecki.com/oauth-2-simplified/)

	*HTTP Servers*
	- [How to set up a HTTP Server](https://www.afternerd.com/blog/python-http-server/)
	- [http.server](https://docs.python.org/3/library/http.server.html#module-http.server)
	- [urllib.parse](https://docs.python.org/3/library/urllib.parse.html)
	- [BaseHTTPRequestHandler Source Code](https://github.com/python/cpython/blob/3.8/Lib/http/server.py)

**For Python Web Server**
- [tecmint "SimpleHTTPServer" Tutorial (deprecated)](https://www.tecmint.com/python-simplehttpserver-to-create-webserver-or-serve-files-instantly/#:~:text=SimpleHTTPServer%20is%20a%20python%20module,you%20have%20python%20interpreter%20installed.)
- [tutorialspoint Python Networking Programming (deprecated?)](https://www.tutorialspoint.com/python_network_programming/python_http_server.htm)
- [http.server documentation](https://docs.python.org/3/library/http.server.html#http.server.SimpleHTTPRequestHandler)
- [afternerd python http.server tutorial](https://www.afternerd.com/blog/python-http-server/)
- [twisted python web server](https://twistedmatrix.com/documents/current/web/howto/using-twistedweb.html)

**For OCR**
- [Taking Screenshots with OpenCV and Python](https://www.pyimagesearch.com/2018/01/01/taking-screenshots-with-opencv-and-python/)
- [TextBlob Documentation](https://textblob.readthedocs.io/en/dev/)
- [OpenCV OCR and text recognition with Tesseract](https://www.pyimagesearch.com/2018/09/17/opencv-ocr-and-text-recognition-with-tesseract/)
- [Installing Tesseract for OCR](https://www.pyimagesearch.com/2017/07/03/installing-tesseract-for-ocr/)
- [Installing OpenCV](https://stackoverflow.com/questions/51853018/how-do-i-install-opencv-using-pip)
- [OCR on inage with text in different colors](https://stackoverflow.com/questions/61134400/pytesseract-ocr-on-image-with-text-in-different-colors)

**For Game Interface**
- [Mac Virtual Keycodes](https://gist.github.com/eegrok/949034)
- [Generating Keyboard Events in Python (stackoverflow)](https://stackoverflow.com/questions/13564851/how-to-generate-keyboard-events-in-python)
- [apple developer quartz event services](https://developer.apple.com/documentation/coregraphics/quartz_event_services#//apple_ref/c/func/CGEventCreateKeyboardEvent)
- [quartz to generate key events](https://stackoverflow.com/questions/6868167/how-to-generate-keyboard-keypress-events-through-python-to-control-pp-presentati)
- [CGEventCreateKeyboardEvent](https://developer.apple.com/documentation/coregraphics/1456564-cgeventcreatekeyboardevent?language=objc)
- [PyPI Quartz page](https://pypi.org/project/pyobjc-framework-Quartz/)
- [hidapi github](https://github.com/libusb/hidapi)
- [cython homepage](https://cython.org/#about)

**Emulator Stuff**
- [TASVideos Emulator Resources](http://tasvideos.org/EmulatorResources/VBA/LuaScriptingFunctions.html)
- [Github TASVideos/vba-rerecording](https://github.com/TASVideos/vba-rerecording)
- [SDL used by vbe-rr](http://www.libsdl.org/)
- [Lua Scripting Example with an SNES emulator on Windows](https://www.twilio.com/blog/2015/08/romram-hacking-building-an-sms-powered-game-genie-with-lua-and-python.html)
- [Lua Homepage](https://www.lua.org/)
- [Lua Manual](https://www.lua.org/manual/5.4/manual.html#2)
- [Python Wrapper Package for Lua](https://pypi.org/project/lupa/)

**Misc**
- [Python Twitch Stream Tutorial](https://317070.github.io/python/)
- [TwitchPlays.py](https://www.dougdougw.com/twitch-plays-code/twitchplays-py)
- [TwitchPlaysX github](https://github.com/hzoo/TwitchPlaysX)
- [make your own twitch plays](https://www.wituz.com/make-your-own-twitch-plays-stream.html)
- [Twitch plays pokemon clone](https://github.com/aidanrwt/twitch-plays)
- [zoom api python wrapper](https://github.com/prschmid/zoomus)
- [ngrok documentation](https://ngrok.com/docs)
- [ngrok how to set up](https://dashboard.ngrok.com/get-started/setup)
- [Base64 Encoding](https://stackabuse.com/encoding-and-decoding-base64-strings-in-python/)
- [Convert Bytes to String](https://stackoverflow.com/questions/606191/convert-bytes-to-a-string)
- [Python multiprocessing](https://docs.python.org/3/library/multiprocessing.html)
- [Creating URL Query Strings](http://www.compciv.org/guides/python/how-tos/creating-proper-url-query-strings/)

### OCR Version Notes (Deprecated)

So instead let's see if we can take live screen-captures of the in-meeting chat log and try to extract the commands from that.

So we're using tesseract and pytesseract as our OCR library/software, and Pillow in order to take screenshots using ImageGrab, which means that this program is only gonna work on Windows and Mac OS.

Using this [stackoverflow post](https://stackoverflow.com/questions/54795273/live-screen-monitoring-with-python3-pytesseract) as inspiration, I've written a test script called `test_tesseract.py` which is a manual loop that takes screenshots of the zoom in-meeting chatbox, determines what new text has appeared on the screen, and prints it, saving the whole chat log to a .txt file separately. 

Tesseract is very good at OCR if the image is black and white, low noise, and the image is black text on white background, which means some image pre-processing is necessary for it to work well on applications with dark mode enabled.

**Step-by-Step Process**
1. Screenshot chatbox area
1. Convert image to greyscale
1. Invert image if chatbox had dark mode active
1. Binarize image to black and white
1. image-to-text using Tesseract

**ALAS, this didn't work as well as I hoped...**
There's no trouble pulling the text, but it's very difficult to determine what commands have already been logged, so the OCR method is unfortunately untenable.

Guess it's either YouTube live stream or Zoom Chats...
For now I will attempt to use the YouTube API in in a different repo
